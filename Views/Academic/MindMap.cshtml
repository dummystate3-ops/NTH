@model BasePageViewModel

@{
    ViewBag.PageTitle = Model.PageTitle;
    ViewBag.MetaDescription = Model.MetaDescription;
    ViewBag.CanonicalUrl = Model.CanonicalUrl;
}

@section Head {
    <link rel="stylesheet" href="~/lib/jsmind/jsmind.css" asp-append-version="true">
    <script src="~/lib/jsmind/jsmind.min.js" asp-append-version="true"></script>
}

<section class="section-padding bg-gradient-to-br from-[var(--color-primary)] via-[var(--color-secondary)] to-[var(--color-accent)] text-white">
    <div class="container-custom">
        <div class="max-w-4xl mx-auto text-center">
            <div class="text-5xl mb-4">üß†</div>
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Mind Map Creator</h1>
            <p class="text-xl opacity-90">Visualize ideas and concepts with interactive mind maps</p>
        </div>
    </div>
</section>

<section class="section-padding">
    <div class="container-custom max-w-6xl">
        
        @{
            var breadcrumbs = new System.Collections.Generic.List<(string Name, string Url)>
            {
                ("Home", Url.Action("Index", "Home") ?? "/"),
                ("All Tools", Url.Action("Index", "Tools") ?? "/Tools"),
                ("Academic & Teacher Tools", (Url.Action("Index", "Tools") ?? "/Tools") + "#academic"),
                ("Mind Map Creator", Url.Action("MindMap", "Academic") ?? "#")
            };
        }
        <partial name="_Breadcrumb" model="breadcrumbs" />
        
        <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4 mb-8">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-green-600 dark:text-green-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <div class="text-sm text-green-900 dark:text-green-100">
                    <strong>Organize your thoughts:</strong> Create, edit, and save mind maps locally. Export and share your ideas easily.
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <div class="lg:col-span-3">
                <div class="card mb-6">
                    <div class="flex flex-wrap items-center gap-4">
                        <input type="text" id="centerTopic" placeholder="Central Topic" 
                               class="flex-1 px-4 py-2 border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] dark:bg-gray-800">
                        <button onclick="createMap()" class="btn-primary">
                            ‚ú® Create Mind Map
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div id="jsmind_container" style="height: 600px; width: 100%;"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="card">
                    <h3 class="text-lg font-bold mb-4">Add Node</h3>
                    <div class="space-y-3">
                        <input type="text" id="newNodeText" placeholder="Node text" 
                               class="w-full px-3 py-2 border border-[var(--color-border)] rounded-lg dark:bg-gray-800">
                        <button onclick="addNode()" class="btn-secondary w-full">
                            ‚ûï Add to Selected
                        </button>
                        <button onclick="removeNode()" class="w-full px-3 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20">
                            ‚ûñ Remove Selected
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-bold mb-4">Actions</h3>
                    <div class="space-y-3">
                        <button onclick="saveMindMap()" class="btn-primary w-full">
                            üíæ Save
                        </button>
                        <button onclick="exportMindMap()" class="btn-secondary w-full">
                            üì§ Export JSON
                        </button>
                        <button onclick="clearMap()" class="w-full px-3 py-2 border border-[var(--color-border)] rounded-lg hover:bg-[var(--color-bg)]">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-bold mb-4">Saved Maps</h3>
                    <div id="savedMaps" class="space-y-2">
                        <p class="text-sm text-[var(--color-text-light)]">No saved maps yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- FAQs -->
        <div class="mt-8 card">
            <h3 class="text-xl font-semibold mb-4">Mind map creator FAQs</h3>
            <div class="space-y-4 text-sm text-[var(--color-text-medium)]">
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">Where are my mind maps saved?</p>
                    <p>
                        Mind maps are stored in your browser‚Äôs local storage on this device. They are available when you return
                        to the same browser, but they are not automatically synced to other devices or user accounts.
                    </p>
                </div>
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">Can I export or import mind maps?</p>
                    <p>
                        Yes. You can export a mind map as a JSON file and later import it back into the tool, or share the file
                        with someone else who can load it into their own browser to view and edit the same map.
                    </p>
                </div>
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">Is the tool suitable for very large mind maps?</p>
                    <p>
                        You can create fairly large diagrams, but extremely complex maps may become harder to navigate or a bit
                        slower to render in the browser. For best usability, keep each map focused on a specific topic or project.
                    </p>
                </div>
            </div>
        </div>

        <!-- Related tools -->
        <div class="mt-6 card">
            <h3 class="text-xl font-semibold mb-4">Related planning tools</h3>
            <div class="flex flex-wrap gap-3 text-sm">
                <a asp-controller="Academic" asp-action="Whiteboard" class="pill-button">
                    Interactive Whiteboard
                </a>
                <a asp-controller="Academic" asp-action="QuizBuilder" class="pill-button">
                    Quiz Builder
                </a>
                <a asp-controller="Academic" asp-action="Flashcards" class="pill-button">
                    Flashcard Generator
                </a>
                <a asp-controller="Productivity" asp-action="KanbanBoard" class="pill-button">
                    Kanban Board
                </a>
            </div>
        </div>

    </div>
</section>

@section Scripts {
    <script>
        let jm = null;
        let savedMaps = JSON.parse(localStorage.getItem('mindMaps') || '[]');
        let nodeCounter = 1;
        let mindLibPromise = null;

        const notifyError = (message) => {
            if (window.toast?.error) {
                window.toast.error(message, { title: 'Mind Map' });
            } else {
                alert(message);
            }
        };

        function ensureMindMapLib() {
            if (window.jsMind) return Promise.resolve(true);
            if (mindLibPromise) return mindLibPromise;

            const sources = [
                '@Url.Content("~/lib/jsmind/jsmind.min.js")',
                'https://cdn.jsdelivr.net/npm/jsmind@0.6.4/es6/jsmind.min.js',
                'https://unpkg.com/jsmind@0.6.4/es6/jsmind.min.js'
            ];

            mindLibPromise = new Promise((resolve) => {
                let index = 0;
                const loadNext = () => {
                    if (window.jsMind) return resolve(true);
                    if (index >= sources.length) return resolve(false);

                    const script = document.createElement('script');
                    script.src = sources[index++];
                    script.async = true;
                    script.crossOrigin = 'anonymous';
                    script.onload = () => {
                        if (window.jsMind) {
                            resolve(true);
                        } else {
                            loadNext();
                        }
                    };
                    script.onerror = loadNext;
                    document.head.appendChild(script);
                };
                loadNext();
            });

            return mindLibPromise;
        }

        async function createMap() {
            if (!(await ensureMindMapLib())) {
                notifyError('Mind map engine failed to load. Please check your connection and try again.');
                return;
            }

            const centerTopic = document.getElementById('centerTopic').value.trim();
            if (!centerTopic) {
                alert('Please enter a central topic');
                return;
            }

            const mind = {
                meta: {
                    name: centerTopic,
                    author: 'NovaTools Hub User',
                    version: '1.0'
                },
                format: 'node_tree',
                data: {
                    id: 'root',
                    topic: centerTopic,
                    isroot: true,
                    children: []
                }
            };

            const options = {
                container: 'jsmind_container',
                theme: 'primary',
                editable: true,
                view: {
                    engine: 'canvas',
                    hmargin: 100,
                    vmargin: 50,
                    line_width: 2,
                    line_color: '#4A90E2'
                }
            };

            if (jm) {
                jm.show(mind);
            } else {
                jm = new jsMind(options);
                jm.show(mind);
            }

            nodeCounter = 1;
        }

        function addNode() {
            if (!jm) {
                alert('Please create a mind map first');
                return;
            }

            const selectedNode = jm.get_selected_node();
            if (!selectedNode) {
                alert('Please select a node first');
                return;
            }

            const text = document.getElementById('newNodeText').value.trim();
            if (!text) {
                alert('Please enter node text');
                return;
            }

            const nodeId = 'node_' + Date.now();
            jm.add_node(selectedNode, nodeId, text);
            document.getElementById('newNodeText').value = '';
            nodeCounter++;
        }

        function removeNode() {
            if (!jm) return;
            
            const selectedNode = jm.get_selected_node();
            if (!selectedNode) {
                alert('Please select a node to remove');
                return;
            }

            if (selectedNode.isroot) {
                alert('Cannot remove the root node');
                return;
            }

            jm.remove_node(selectedNode);
        }

        function saveMindMap() {
            if (!jm) {
                alert('Please create a mind map first');
                return;
            }

            const name = prompt('Enter a name for this mind map:');
            if (!name) return;

            const data = jm.get_data();
            savedMaps.push({
                id: Date.now(),
                name,
                data: data,
                date: new Date().toLocaleDateString()
            });

            localStorage.setItem('mindMaps', JSON.stringify(savedMaps));
            renderSavedMaps();
            alert('Mind map saved!');
        }

        function exportMindMap() {
            if (!jm) {
                alert('Please create a mind map first');
                return;
            }

            const data = jm.get_data();
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mindmap_${Date.now()}.json`;
            a.click();
        }

        function clearMap() {
            if (!jm) return;
            if (confirm('Clear the entire mind map?')) {
                document.getElementById('centerTopic').value = '';
                document.getElementById('jsmind_container').innerHTML = '';
                jm = null;
            }
        }

        function renderSavedMaps() {
            const container = document.getElementById('savedMaps');
            
            if (savedMaps.length === 0) {
                container.innerHTML = '<p class="text-sm text-[var(--color-text-light)]">No saved maps yet</p>';
                return;
            }

            container.innerHTML = savedMaps.map(map => `
                <div class="border border-[var(--color-border)] rounded p-3 bg-[var(--color-surface)]">
                    <div class="font-semibold text-sm mb-1">${map.name}</div>
                    <div class="text-xs text-[var(--color-text-light)] mb-2">${map.date}</div>
                    <div class="flex gap-2">
                        <button onclick="loadMap(${map.id})" class="text-xs px-2 py-1 bg-[var(--color-primary)] text-white rounded hover:opacity-90">
                            Load
                        </button>
                        <button onclick="deleteMap(${map.id})" class="text-xs px-2 py-1 text-red-600 hover:underline">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function loadMap(id) {
            if (!(await ensureMindMapLib())) {
                notifyError('Mind map engine failed to load. Please check your connection and try again.');
                return;
            }

            const map = savedMaps.find(m => m.id === id);
            if (!map) return;

            const options = {
                container: 'jsmind_container',
                theme: 'primary',
                editable: true,
                view: {
                    engine: 'canvas',
                    hmargin: 100,
                    vmargin: 50,
                    line_width: 2,
                    line_color: '#4A90E2'
                }
            };

            if (jm) {
                jm.show(map.data);
            } else {
                jm = new jsMind(options);
                jm.show(map.data);
            }

            document.getElementById('centerTopic').value = map.data.data.topic;
        }

        function deleteMap(id) {
            if (!confirm('Delete this mind map?')) return;
            savedMaps = savedMaps.filter(m => m.id !== id);
            localStorage.setItem('mindMaps', JSON.stringify(savedMaps));
            renderSavedMaps();
        }

        // Initialize
        renderSavedMaps();
    </script>
    
    <style>
        #jsmind_container {
            background: var(--color-surface);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        jmnode {
            background-color: var(--color-primary) !important;
            color: white !important;
            border-radius: 0.375rem !important;
            padding: 8px 16px !important;
            font-size: 14px !important;
        }
        
        jmnode.selected {
            background-color: var(--color-accent) !important;
            box-shadow: 0 0 10px rgba(0,0,0,0.2) !important;
        }
    </style>
}
