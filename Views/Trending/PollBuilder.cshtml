@model BasePageViewModel

@{
    ViewBag.PageTitle = Model.PageTitle;
    ViewBag.MetaDescription = Model.MetaDescription;
    ViewBag.CanonicalUrl = Model.CanonicalUrl;
}

<!-- Page Header -->
<section class="section-padding bg-gradient-to-br from-[var(--color-primary)] via-[var(--color-secondary)] to-[var(--color-accent)] text-white">
    <div class="container-custom">
        <div class="max-w-4xl mx-auto text-center">
            <div class="text-6xl mb-4">üìä</div>
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Quick Poll Builder</h1>
            <p class="text-xl opacity-90">Create polls and surveys with instant visual results</p>
        </div>
    </div>
</section>

<!-- Tool Section -->
<section class="section-padding">
    <div class="container-custom max-w-5xl">
        @{
            var breadcrumbs = new System.Collections.Generic.List<(string Name, string Url)>
            {
                ("Home", Url.Action("Index", "Home") ?? "/"),
                ("All Tools", Url.Action("Index", "Tools") ?? "/Tools"),
                ("Trending & AI Tools", (Url.Action("Index", "Tools") ?? "/Tools") + "#trending"),
                ("Quick Poll Builder", Url.Action("PollBuilder", "Trending") ?? "#")
            };
        }
        <partial name="_Breadcrumb" model="breadcrumbs" />
        <form id="pollForm">
            @Html.AntiForgeryToken()
        </form>
        
        <!-- View Mode Selection -->
        <div class="tool-card mb-8">
            <div class="flex flex-wrap gap-4">
                <button id="view-create" type="button" class="btn-primary flex-1 min-w-[200px]">‚úèÔ∏è Create Poll</button>
                <button id="view-vote" type="button" class="btn-secondary flex-1 min-w-[200px]">üó≥Ô∏è Vote on Polls</button>
                <button id="view-results" type="button" class="btn-accent flex-1 min-w-[200px]">üìà View Results</button>
            </div>
        </div>

        <!-- Create Poll Mode -->
        <div id="create-mode" class="tool-card">
            <h2 class="text-2xl font-bold mb-4 text-[var(--color-text-dark)]">Create New Poll</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]">Poll Question</label>
                    <input type="text" id="poll-question" class="w-full p-3 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)]" placeholder="What is your question?">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]">Options (2-10)</label>
                    <div id="poll-options" class="space-y-2">
                        <input type="text" class="poll-option w-full p-3 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)]" placeholder="Option 1">
                        <input type="text" class="poll-option w-full p-3 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)]" placeholder="Option 2">
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <button id="add-option" type="button" class="btn-secondary">+ Add Option</button>
                        <button id="remove-option" type="button" class="text-sm text-[var(--color-text-medium)] hover:text-[var(--color-primary)]">Remove last option</button>
                    </div>
                </div>

                <button id="create-poll" type="button" class="btn-primary w-full">üìä Create Poll</button>

                <div id="share-section" class="hidden bg-green-50 border border-green-200 rounded-lg p-4">
                    <p class="text-green-800 text-sm">Poll created! Share this ID:</p>
                    <div class="flex items-center gap-2 mt-2">
                        <input id="share-id" readonly class="flex-1 px-3 py-2 border border-green-300 rounded bg-white text-sm" />
                        <button id="share-copy" type="button" class="btn-secondary">Copy</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vote on Polls Mode -->
        <div id="vote-mode" class="hidden">
            <div class="tool-card mb-4">
                <div class="flex flex-col gap-3 md:flex-row md:items-end">
                    <div class="flex-1">
                        <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]">Poll ID</label>
                        <input type="text" id="load-poll-id" class="w-full p-3 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)]" placeholder="Paste poll ID">
                    </div>
                    <button id="load-poll" type="button" class="btn-primary md:w-auto w-full">Load Poll</button>
                </div>
            </div>

            <div id="poll-card" class="tool-card hidden"></div>
            <div id="no-polls" class="tool-card text-center py-12 text-[var(--color-text-medium)]">
                <div class="text-6xl mb-4">üìã</div>
                <p class="text-xl">No poll loaded. Paste an ID above to vote.</p>
            </div>
        </div>

        <!-- Results Mode -->
        <div id="results-mode" class="hidden">
            <div id="results-card" class="tool-card hidden">
                <!-- Results will be injected here -->
            </div>
            <div id="analytics-card" class="tool-card hidden mt-4">
                <!-- Analytics insights will be injected here -->
            </div>
            <div id="no-results" class="tool-card text-center py-12 text-[var(--color-text-medium)]">
                <div class="text-6xl mb-4">üìä</div>
                <p class="text-xl">Load a poll to see results.</p>
            </div>
        </div>

        <!-- Privacy Notice -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-6 rounded-lg mt-8">
            <p class="text-blue-800">
                <strong>üîí Privacy:</strong> Polls and votes are stored on the server with minimal metadata. Voter tracking is limited to a cookie to prevent duplicate votes.
            </p>
        </div>

        <!-- FAQs -->
        <div class="mt-8 card">
            <h3 class="text-xl font-semibold mb-4">Poll builder FAQs</h3>
            <div class="space-y-4 text-sm text-[var(--color-text-medium)]">
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">How do I share a poll with participants?</p>
                    <p>
                        After creating a poll you receive a poll ID. Share this ID with your audience so they can load the poll,
                        cast a vote, and view aggregated results depending on which view mode they use.
                    </p>
                </div>
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">Can people vote more than once?</p>
                    <p>
                        The tool uses a browser cookie to reduce duplicate voting from the same device, but it is not a strong
                        identity check. For high-stakes surveys you should combine this with your own participant controls.
                    </p>
                </div>
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">How can I use poll results in reports?</p>
                    <p>
                        You can export results as CSV and download chart images directly from the results view. This makes it easy
                        to embed charts and tables in presentations, documents, or dashboards.
                    </p>
                </div>
            </div>
        </div>

        <!-- In-Content Ad -->
        @await Html.PartialAsync("_AdInContent")

        <!-- Social Sharing -->
        <div class="mt-8">
            <partial name="_SocialSharing" />
        </div>
    </div>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const token = document.querySelector('#pollForm input[name="__RequestVerificationToken"]')?.value;
        let loadedPoll = null;

        const viewButtons = {
            create: document.getElementById('view-create'),
            vote: document.getElementById('view-vote'),
            results: document.getElementById('view-results')
        };
        const viewModes = {
            create: document.getElementById('create-mode'),
            vote: document.getElementById('vote-mode'),
            results: document.getElementById('results-mode')
        };

        function switchView(view) {
            Object.keys(viewButtons).forEach(key => {
                const btn = viewButtons[key];
                const mode = viewModes[key];
                
                if (key === view) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    if (key === 'create') btn.classList.add('btn-primary');
                    else if (key === 'vote') btn.classList.add('btn-secondary');
                    else btn.classList.add('btn-accent');
                    mode.classList.remove('hidden');
                } else {
                    btn.classList.remove('btn-primary', 'btn-secondary', 'btn-accent');
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    mode.classList.add('hidden');
                }
            });

            if (view === 'vote') renderPollCard();
            if (view === 'results') renderResults();
        }

        viewButtons.create.addEventListener('click', () => switchView('create'));
        viewButtons.vote.addEventListener('click', () => switchView('vote'));
        viewButtons.results.addEventListener('click', () => switchView('results'));

        // Option add/remove
        document.getElementById('add-option').addEventListener('click', () => {
            const container = document.getElementById('poll-options');
            const count = container.querySelectorAll('.poll-option').length;
            if (count >= 10) return alert('Maximum 10 options allowed');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'poll-option w-full p-3 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)]';
            input.placeholder = `Option ${count + 1}`;
            container.appendChild(input);
        });

        document.getElementById('remove-option').addEventListener('click', () => {
            const container = document.getElementById('poll-options');
            const inputs = container.querySelectorAll('.poll-option');
            if (inputs.length > 2) {
                container.removeChild(inputs[inputs.length - 1]);
            }
        });

        // Create poll
        document.getElementById('create-poll').addEventListener('click', async () => {
            const question = document.getElementById('poll-question').value.trim();
            const options = Array.from(document.querySelectorAll('.poll-option'))
                .map(i => i.value.trim())
                .filter(Boolean);

            if (!question) return alert('Please enter a question');
            if (options.length < 2) return alert('Please provide at least 2 options');

            const formData = new FormData();
            formData.append('Question', question);
            options.forEach(o => formData.append('Options', o));
            if (token) formData.append('__RequestVerificationToken', token);

            const res = await fetch('/Poll/Create', {
                method: 'POST',
                body: formData,
                headers: token ? { 'RequestVerificationToken': token } : {}
            });
            const result = await res.json();
            if (result.success) {
                document.getElementById('share-id').value = result.pollId;
                document.getElementById('share-section').classList.remove('hidden');
                localStorage.setItem('lastPollId', result.pollId);
                switchView('vote');
                document.getElementById('load-poll-id').value = result.pollId;
                await loadPoll(result.pollId);
            } else {
                alert(result.error || 'Failed to create poll.');
            }
        });

        document.getElementById('share-copy').addEventListener('click', () => {
            const text = document.getElementById('share-id').value;
            navigator.clipboard.writeText(text).then(() => {
                document.getElementById('share-copy').textContent = 'Copied!';
                setTimeout(() => document.getElementById('share-copy').textContent = 'Copy', 1500);
            });
        });

        // Load poll
        document.getElementById('load-poll').addEventListener('click', async () => {
            const id = document.getElementById('load-poll-id').value.trim();
            if (!id) return alert('Enter a poll ID');
            await loadPoll(id);
        });

        async function loadPoll(id) {
            const res = await fetch(`/Poll/Get?id=${encodeURIComponent(id)}`);
            const result = await res.json();
            if (result.success) {
                loadedPoll = result.poll;
                localStorage.setItem('lastPollId', loadedPoll.pollId);
                renderPollCard();
                renderResults();
                return true;
            } else {
                alert(result.error || 'Unable to load poll.');
                return false;
            }
        }

        // Render poll for voting
        function renderPollCard() {
            const card = document.getElementById('poll-card');
            const noPolls = document.getElementById('no-polls');
            if (!loadedPoll) {
                card.classList.add('hidden');
                noPolls.classList.remove('hidden');
                return;
            }
            noPolls.classList.add('hidden');
            card.classList.remove('hidden');

            const optionsHtml = loadedPoll.options.map(opt => `
                <label class="flex items-center space-x-3 p-3 bg-[var(--color-neutral-100)] rounded-lg cursor-pointer hover:bg-[var(--color-neutral-200)]">
                    <input type="radio" name="poll-vote" value="${opt.optionId}" class="poll-vote-option">
                    <span class="flex-1">${opt.text}</span>
                    <span class="text-sm text-[var(--color-text-medium)]">${opt.votes} votes</span>
                </label>
            `).join('');

            card.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-[var(--color-text-dark)]">${loadedPoll.question}</h3>
                <div class="space-y-2 mb-4">
                    ${optionsHtml}
                </div>
                <button id="vote-submit" type="button" class="btn-primary w-full">üó≥Ô∏è Submit Vote</button>
            `;

            document.getElementById('vote-submit').addEventListener('click', submitVote);
        }

        async function submitVote() {
            const selected = document.querySelector('input[name="poll-vote"]:checked');
            if (!selected) return alert('Please select an option');
            const optionId = selected.value;

            const formData = new FormData();
            formData.append('PollId', loadedPoll.pollId);
            formData.append('OptionId', optionId);
            if (token) formData.append('__RequestVerificationToken', token);

            const res = await fetch('/Poll/Vote', {
                method: 'POST',
                body: formData,
                headers: token ? { 'RequestVerificationToken': token } : {}
            });
            const result = await res.json();
            if (result.success) {
                loadedPoll = result.poll;
                renderPollCard();
                renderResults();
                alert('Vote submitted!');
            } else {
                alert(result.error || 'Unable to submit vote.');
            }
        }

        // Render results with enhanced analytics
        let resultsChart = null;
        let currentChartType = 'bar';
        
        function renderResults() {
            const card = document.getElementById('results-card');
            const analyticsCard = document.getElementById('analytics-card');
            const none = document.getElementById('no-results');
            
            if (!loadedPoll) {
                card.classList.add('hidden');
                analyticsCard.classList.add('hidden');
                none.classList.remove('hidden');
                return;
            }
            none.classList.add('hidden');
            card.classList.remove('hidden');
            analyticsCard.classList.remove('hidden');

            const chartId = 'poll-results-chart';
            const totalVotes = loadedPoll.totalVotes;
            
            // Calculate percentages and find insights
            const optionsWithStats = loadedPoll.options.map(o => ({
                ...o,
                percentage: totalVotes > 0 ? ((o.votes / totalVotes) * 100).toFixed(1) : 0
            }));
            
            // Sort by votes to find leader
            const sorted = [...optionsWithStats].sort((a, b) => b.votes - a.votes);
            const leader = sorted[0];
            const runnerUp = sorted[1];
            const isCloseRace = leader && runnerUp && (leader.votes - runnerUp.votes) <= totalVotes * 0.1 && totalVotes > 5;
            const isClearWinner = leader && runnerUp && leader.votes > runnerUp.votes * 2 && totalVotes > 5;
            
            // Results breakdown table
            const breakdownHtml = optionsWithStats.map((opt, idx) => `
                <div class="flex items-center justify-between p-3 ${idx === 0 ? 'bg-[var(--color-primary)]/10 rounded-lg border-l-4 border-[var(--color-primary)]' : 'border-b border-[var(--color-border)]'}">
                    <div class="flex items-center gap-3">
                        <span class="text-lg font-bold text-[var(--color-text-medium)]">#${idx + 1}</span>
                        <span class="font-medium">${opt.text}</span>
                        ${idx === 0 && totalVotes > 0 ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">üëë Leading</span>' : ''}
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-[var(--color-text-medium)]">${opt.votes} votes</span>
                        <span class="font-bold text-[var(--color-primary)]">${opt.percentage}%</span>
                    </div>
                </div>
            `).join('');

            card.innerHTML = `
                <div class="flex flex-wrap justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-[var(--color-text-dark)]">${loadedPoll.question}</h3>
                    <div class="flex gap-2 mt-2 md:mt-0">
                        <button id="chart-bar" class="px-3 py-1 text-sm rounded ${currentChartType === 'bar' ? 'bg-[var(--color-primary)] text-white' : 'bg-gray-200 text-gray-700'}" title="Bar Chart">üìä</button>
                        <button id="chart-pie" class="px-3 py-1 text-sm rounded ${currentChartType === 'pie' ? 'bg-[var(--color-primary)] text-white' : 'bg-gray-200 text-gray-700'}" title="Pie Chart">ü•ß</button>
                        <button id="chart-doughnut" class="px-3 py-1 text-sm rounded ${currentChartType === 'doughnut' ? 'bg-[var(--color-primary)] text-white' : 'bg-gray-200 text-gray-700'}" title="Doughnut Chart">üç©</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <canvas id="${chartId}" style="max-height: 300px;"></canvas>
                    </div>
                    <div class="space-y-1">
                        <h4 class="text-sm font-semibold text-[var(--color-text-medium)] mb-3">üìã Results Breakdown</h4>
                        ${breakdownHtml}
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-3 mt-6 pt-4 border-t border-[var(--color-border)]">
                    <div class="text-sm text-[var(--color-text-medium)]">üìä Total votes: <strong>${totalVotes}</strong></div>
                    <div class="text-sm text-[var(--color-text-medium)]">üìà Options: <strong>${loadedPoll.options.length}</strong></div>
                    <button id="export-csv" class="ml-auto text-sm px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">üì• Export CSV</button>
                    <button id="export-image" class="text-sm px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">üì∑ Save Chart</button>
                </div>
            `;

            // Analytics insights
            let insightsHtml = '';
            if (totalVotes === 0) {
                insightsHtml = `
                    <div class="flex items-center gap-3 p-4 bg-yellow-50 rounded-lg">
                        <span class="text-2xl">‚è≥</span>
                        <div>
                            <p class="font-semibold text-yellow-800">Waiting for votes</p>
                            <p class="text-sm text-yellow-700">Share your poll to start collecting responses!</p>
                        </div>
                    </div>
                `;
            } else if (isCloseRace) {
                insightsHtml = `
                    <div class="flex items-center gap-3 p-4 bg-orange-50 rounded-lg">
                        <span class="text-2xl">üî•</span>
                        <div>
                            <p class="font-semibold text-orange-800">Close race!</p>
                            <p class="text-sm text-orange-700">"${leader.text}" leads "${runnerUp.text}" by only ${leader.votes - runnerUp.votes} vote(s). Every vote counts!</p>
                        </div>
                    </div>
                `;
            } else if (isClearWinner) {
                insightsHtml = `
                    <div class="flex items-center gap-3 p-4 bg-green-50 rounded-lg">
                        <span class="text-2xl">üèÜ</span>
                        <div>
                            <p class="font-semibold text-green-800">Clear leader!</p>
                            <p class="text-sm text-green-700">"${leader.text}" is winning with ${leader.percentage}% of the votes.</p>
                        </div>
                    </div>
                `;
            } else if (totalVotes >= 3) {
                insightsHtml = `
                    <div class="flex items-center gap-3 p-4 bg-blue-50 rounded-lg">
                        <span class="text-2xl">üìà</span>
                        <div>
                            <p class="font-semibold text-blue-800">Votes coming in!</p>
                            <p class="text-sm text-blue-700">"${leader.text}" currently leads with ${leader.votes} votes (${leader.percentage}%).</p>
                        </div>
                    </div>
                `;
            } else {
                insightsHtml = `
                    <div class="flex items-center gap-3 p-4 bg-purple-50 rounded-lg">
                        <span class="text-2xl">üöÄ</span>
                        <div>
                            <p class="font-semibold text-purple-800">Poll is live!</p>
                            <p class="text-sm text-purple-700">Share with more people to get meaningful insights.</p>
                        </div>
                    </div>
                `;
            }
            
            analyticsCard.innerHTML = `
                <h4 class="text-lg font-bold mb-3 text-[var(--color-text-dark)]">üìä Poll Insights</h4>
                ${insightsHtml}
            `;

            // Setup chart
            setTimeout(() => {
                createChart(chartId, currentChartType);
                
                // Chart type buttons
                document.getElementById('chart-bar')?.addEventListener('click', () => {
                    currentChartType = 'bar';
                    renderResults();
                });
                document.getElementById('chart-pie')?.addEventListener('click', () => {
                    currentChartType = 'pie';
                    renderResults();
                });
                document.getElementById('chart-doughnut')?.addEventListener('click', () => {
                    currentChartType = 'doughnut';
                    renderResults();
                });
                
                // Export buttons
                document.getElementById('export-csv')?.addEventListener('click', exportCSV);
                document.getElementById('export-image')?.addEventListener('click', exportImage);
            }, 100);
        }
        
        function createChart(chartId, type) {
            const ctx = document.getElementById(chartId)?.getContext('2d');
            if (!ctx) return;
            
            if (resultsChart) {
                resultsChart.destroy();
            }
            
            const colors = ['#4A90E2','#50E3C2','#9B59B6','#E74C3C','#F39C12','#1ABC9C','#3498DB','#E67E22','#2ECC71','#95A5A6'];
            
            const config = {
                type: type,
                data: {
                    labels: loadedPoll.options.map(o => o.text),
                    datasets: [{
                        label: 'Votes',
                        data: loadedPoll.options.map(o => o.votes),
                        backgroundColor: colors.slice(0, loadedPoll.options.length),
                        borderColor: type === 'bar' ? colors.slice(0, loadedPoll.options.length) : '#fff',
                        borderWidth: type === 'bar' ? 0 : 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { 
                        legend: { 
                            display: type !== 'bar',
                            position: 'bottom'
                        }
                    },
                    scales: type === 'bar' ? { 
                        y: { beginAtZero: true, ticks: { precision: 0 } } 
                    } : {}
                }
            };
            
            resultsChart = new Chart(ctx, config);
        }
        
        function exportCSV() {
            if (!loadedPoll) return;
            
            const totalVotes = loadedPoll.totalVotes;
            let csv = 'Option,Votes,Percentage\n';
            loadedPoll.options.forEach(opt => {
                const pct = totalVotes > 0 ? ((opt.votes / totalVotes) * 100).toFixed(1) : 0;
                csv += `"${opt.text}",${opt.votes},${pct}%\n`;
            });
            csv += `\nTotal,${totalVotes},100%\n`;
            csv += `\nPoll Question: "${loadedPoll.question}"\n`;
            csv += `Poll ID: ${loadedPoll.pollId}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `poll-results-${loadedPoll.pollId}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportImage() {
            const canvas = document.getElementById('poll-results-chart');
            if (!canvas) return;
            
            const url = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = `poll-chart-${loadedPoll.pollId}.png`;
            a.click();
        }

        // Auto-load last poll if available
        const lastPollId = localStorage.getItem('lastPollId');
        if (lastPollId) {
            document.getElementById('load-poll-id').value = lastPollId;
            loadPoll(lastPollId);
        }
    </script>
}
