@model BasePageViewModel

@{
    ViewBag.PageTitle = Model.PageTitle;
    ViewBag.MetaDescription = Model.MetaDescription;
    ViewBag.CanonicalUrl = Model.CanonicalUrl;
}

<section class="section-padding bg-gradient-to-br from-[var(--color-primary)] via-[var(--color-secondary)] to-[var(--color-accent)] text-white">
    <div class="container-custom">
        <div class="max-w-5xl mx-auto text-center">
            <div class="flex flex-wrap justify-center gap-3 mb-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-white/15 text-sm font-semibold uppercase tracking-wide">Live</span>
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-white/15 text-sm font-semibold uppercase tracking-wide">OpenRouter</span>
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-white/15 text-sm font-semibold uppercase tracking-wide">Secure</span>
            </div>
            <div class="text-5xl md:text-6xl mb-2 font-extrabold tracking-tight">AI Writing Assistant</div>
            <p class="text-lg md:text-xl opacity-95 max-w-3xl mx-auto">Draft, summarize, and polish text with instant server-backed responses. Tuned for clarity, speed, and mobile-friendly editing.</p>
        </div>
    </div>
</section>

<section class="section-padding">
    <div class="container-custom max-w-6xl">
        @{
            var breadcrumbs = new System.Collections.Generic.List<(string Name, string Url)>
            {
                ("Home", Url.Action("Index", "Home") ?? "/"),
                ("All Tools", Url.Action("Index", "Tools") ?? "/Tools"),
                ("Trending & AI Tools", (Url.Action("Index", "Tools") ?? "/Tools") + "#trending"),
                ("AI Writing Assistant", Url.Action("AIWritingAssistant", "Trending") ?? "#")
            };
        }
        <partial name="_Breadcrumb" model="breadcrumbs" />
        <form id="aiForm">
            @Html.AntiForgeryToken()
        </form>

        <div id="ai-alert" class="hidden mb-4 rounded-lg border px-4 py-3 text-sm"></div>

        <div class="tool-card mb-6">
            <div class="flex flex-wrap gap-3 items-center justify-between">
                <div class="flex flex-wrap gap-2 flex-1">
                    <button type="button" data-mode-btn="draft" class="mode-btn btn-primary flex-1 min-w-[160px] rounded-full shadow-lg shadow-[var(--color-primary)]/20 transition-transform hover:-translate-y-0.5">Draft</button>
                    <button type="button" data-mode-btn="summarize" class="mode-btn bg-gray-100 text-gray-800 hover:bg-gray-200 flex-1 min-w-[160px] rounded-full border border-[var(--color-border)] transition-transform hover:-translate-y-0.5">Summarize</button>
                    <button type="button" data-mode-btn="improve" class="mode-btn bg-gray-100 text-gray-800 hover:bg-gray-200 flex-1 min-w-[160px] rounded-full border border-[var(--color-border)] transition-transform hover:-translate-y-0.5">Improve</button>
                </div>
                <div class="flex items-center gap-2 text-sm text-[var(--color-text-medium)] bg-[var(--color-neutral-100)] px-3 py-2 rounded-lg">
                    <span class="inline-block w-2 h-2 rounded-full bg-emerald-500"></span>
                    <span>Live model: Grok</span>
                </div>
            </div>
            <div id="ai-status" class="mt-3 flex flex-wrap items-center gap-3 text-sm text-[var(--color-text-medium)]">
                <div class="flex items-center gap-2 px-3 py-2 bg-[var(--color-neutral-100)] rounded-lg border border-[var(--color-border)]">
                    <span class="inline-block w-2 h-2 rounded-full bg-emerald-500" id="ai-status-dot"></span>
                    <span id="ai-status-text">Ready</span>
                </div>
                <div class="text-xs uppercase tracking-wide text-[var(--color-text-light)]">Last action: <span id="ai-last-action">None</span></div>
            </div>
        </div>

        <!-- Draft Content Mode -->
        <div id="draft-mode" class="tool-card mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                <div>
                    <h2 class="text-2xl font-bold text-[var(--color-text-dark)]">Draft content</h2>
                    <p class="text-[var(--color-text-medium)]">Describe what you need. The assistant will outline and draft in the selected tone and length.</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button type="button" class="sample-btn px-3 py-2 rounded-full border border-[var(--color-border)] text-sm hover:border-[var(--color-primary)] transition-colors" data-sample="Write a launch announcement for a new productivity app focusing on remote teams.">Sample: Launch note</button>
                    <button type="button" class="sample-btn px-3 py-2 rounded-full border border-[var(--color-border)] text-sm hover:border-[var(--color-primary)] transition-colors" data-sample="Create a three-paragraph blog intro about sustainable packaging for small e-commerce brands.">Sample: Blog intro</button>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]" for="draft-prompt">Topic or prompt</label>
                    <textarea id="draft-prompt" rows="4" maxlength="4000" class="w-full p-4 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent resize-none" placeholder="E.g., Write a blog intro about remote productivity"></textarea>
                    <div class="text-xs text-[var(--color-text-medium)] mt-1" id="draft-count">0 / 4000 characters</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]" for="draft-tone">Tone</label>
                        <select id="draft-tone" class="w-full p-3 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)]">
                            <option value="professional">Professional</option>
                            <option value="casual">Casual</option>
                            <option value="friendly">Friendly</option>
                            <option value="formal">Formal</option>
                            <option value="creative">Creative</option>
                            <option value="neutral" selected>Neutral</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]" for="draft-length">Length</label>
                        <select id="draft-length" class="w-full p-3 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)]">
                            <option value="short">Short (1-2 paragraphs)</option>
                            <option value="medium" selected>Medium (3 paragraphs)</option>
                            <option value="long">Long (4+ paragraphs)</option>
                        </select>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2">
                    <span class="text-xs text-[var(--color-text-medium)]">Quick tones:</span>
                    <button type="button" class="tone-chip px-3 py-1 rounded-full border text-xs hover:border-[var(--color-primary)] transition-colors" data-tone="professional">Professional</button>
                    <button type="button" class="tone-chip px-3 py-1 rounded-full border text-xs hover:border-[var(--color-primary)] transition-colors" data-tone="friendly">Friendly</button>
                    <button type="button" class="tone-chip px-3 py-1 rounded-full border text-xs hover:border-[var(--color-primary)] transition-colors" data-tone="creative">Creative</button>
                    <button type="button" class="tone-chip px-3 py-1 rounded-full border text-xs hover:border-[var(--color-primary)] transition-colors" data-tone="casual">Casual</button>
                </div>

                <button id="draft-generate" type="button" class="btn-primary w-full flex items-center justify-center gap-2 rounded-full shadow-lg shadow-[var(--color-primary)]/25 transition-transform hover:-translate-y-0.5">
                    <span class="btn-label">Generate draft</span>
                    <span class="btn-loading hidden">Working...</span>
                </button>
            </div>

            <div id="draft-result" class="mt-6 hidden">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xl font-bold text-[var(--color-text-dark)]">Generated draft</h3>
                    <button id="draft-copy" type="button" class="btn-secondary text-sm rounded-full flex items-center gap-2 px-4 transition-transform hover:-translate-y-0.5 active:scale-[0.98]">
                        <svg class="w-4 h-4 copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 9h11v11H9z"/><path d="M5 5h11v11H5z"/></svg>
                        <svg class="w-4 h-4 check-icon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
                        <span class="text-xs uppercase tracking-wide">Copy</span>
                    </button>
                </div>
                <div id="draft-output" class="p-5 bg-[var(--color-neutral-100)] rounded-lg border border-[var(--color-neutral-300)] whitespace-pre-wrap"></div>
                <div id="draft-meta" class="mt-3 text-xs text-[var(--color-text-medium)] hidden"></div>
            </div>
        </div>

        <!-- Summarize Mode -->
        <div id="summarize-mode" class="tool-card mb-8 hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                <div>
                    <h2 class="text-2xl font-bold text-[var(--color-text-dark)]">Summarize text</h2>
                    <p class="text-[var(--color-text-medium)]">Paste content and choose how concise the summary should be.</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button type="button" class="sample-btn px-3 py-2 rounded-full border border-[var(--color-border)] text-sm hover:border-[var(--color-primary)] transition-colors" data-sample="Summarize the key findings of this quarterly report: revenue growth of 12%, churn reduction of 1.5 points, and a successful beta launch of the mobile app.">Sample: Summary</button>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]" for="summarize-text">Text to summarize</label>
                    <textarea id="summarize-text" rows="8" maxlength="6000" class="w-full p-4 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent resize-none" placeholder="Paste the text you want to summarize..."></textarea>
                    <div class="flex justify-between text-xs text-[var(--color-text-medium)] mt-1">
                        <span id="summarize-word-count">Words: 0</span>
                        <span id="summarize-char-count">Characters: 0 / 6000</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]" for="summarize-length">Summary length</label>
                    <select id="summarize-length" class="w-full p-3 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)]">
                        <option value="brief">Brief (1-2 sentences)</option>
                        <option value="medium" selected>Medium (3-4 sentences)</option>
                        <option value="detailed">Detailed (5+ sentences)</option>
                    </select>
                </div>

                <button id="summarize-generate" type="button" class="btn-primary w-full flex items-center justify-center gap-2 rounded-full shadow-lg shadow-[var(--color-primary)]/25 transition-transform hover:-translate-y-0.5">
                    <span class="btn-label">Generate summary</span>
                    <span class="btn-loading hidden">Summarizing...</span>
                </button>
            </div>

            <div id="summarize-result" class="mt-6 hidden">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xl font-bold text-[var(--color-text-dark)]">Summary</h3>
                    <button id="summarize-copy" type="button" class="btn-secondary text-sm rounded-full flex items-center gap-2 px-4 transition-transform hover:-translate-y-0.5 active:scale-[0.98]">
                        <svg class="w-4 h-4 copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 9h11v11H9z"/><path d="M5 5h11v11H5z"/></svg>
                        <svg class="w-4 h-4 check-icon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
                        <span class="text-xs uppercase tracking-wide">Copy</span>
                    </button>
                </div>
                <div id="summarize-output" class="p-5 bg-[var(--color-neutral-100)] rounded-lg border border-[var(--color-neutral-300)] whitespace-pre-wrap"></div>
                <div id="summarize-meta" class="mt-3 text-xs text-[var(--color-text-medium)] hidden"></div>
            </div>
        </div>

        <!-- Improve Mode -->
        <div id="improve-mode" class="tool-card mb-8 hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
                <div>
                    <h2 class="text-2xl font-bold text-[var(--color-text-dark)]">Improve writing</h2>
                    <p class="text-[var(--color-text-medium)]">Get suggestions for clarity, grammar, and structure. Optional: set a goal for the rewrite.</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button type="button" class="sample-btn px-3 py-2 rounded-full border border-[var(--color-border)] text-sm hover:border-[var(--color-primary)] transition-colors" data-sample="I would like to make this paragraph more concise and reader-friendly for a landing page hero section.">Sample: Goal</button>
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]" for="improve-text">Your text</label>
                    <textarea id="improve-text" rows="8" maxlength="6000" class="w-full p-4 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent resize-none" placeholder="Paste or type the text you want to improve..."></textarea>
                    <div class="flex justify-between text-xs text-[var(--color-text-medium)] mt-1">
                        <span id="improve-word-count">Words: 0</span>
                        <span id="improve-char-count">Characters: 0 / 6000</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]" for="improve-goal">Goal (optional)</label>
                    <input id="improve-goal" type="text" maxlength="200" class="w-full p-3 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)]" placeholder="E.g., Make it more persuasive">
                </div>

                <button id="improve-generate" type="button" class="btn-primary w-full flex items-center justify-center gap-2 rounded-full shadow-lg shadow-[var(--color-primary)]/25 transition-transform hover:-translate-y-0.5">
                    <span class="btn-label">Improve text</span>
                    <span class="btn-loading hidden">Improving...</span>
                </button>
            </div>

            <div id="improve-result" class="mt-6 hidden">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xl font-bold text-[var(--color-text-dark)]">Improved version</h3>
                    <button id="improve-copy" type="button" class="btn-secondary text-sm rounded-full flex items-center gap-2 px-4 transition-transform hover:-translate-y-0.5 active:scale-[0.98]">
                        <svg class="w-4 h-4 copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 9h11v11H9z"/><path d="M5 5h11v11H5z"/></svg>
                        <svg class="w-4 h-4 check-icon hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
                        <span class="text-xs uppercase tracking-wide">Copy</span>
                    </button>
                </div>
                <div id="improve-output" class="p-5 bg-[var(--color-neutral-100)] rounded-lg border border-[var(--color-neutral-300)] whitespace-pre-wrap"></div>
                <div id="improve-meta" class="mt-3 text-xs text-[var(--color-text-medium)] hidden"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">
            <div class="tool-card">
                <h4 class="font-semibold text-[var(--color-text-dark)] mb-2">Best results</h4>
                <ul class="text-sm space-y-1 text-[var(--color-text-medium)]">
                    <li>Provide audience and goal (e.g., newsletter readers, landing page hero).</li>
                    <li>Set tone + length explicitly for consistent style.</li>
                    <li>Use the goal field to steer improvements.</li>
                </ul>
            </div>
            <div class="tool-card">
                <h4 class="font-semibold text-[var(--color-text-dark)] mb-2">Safety & privacy</h4>
                <ul class="text-sm space-y-1 text-[var(--color-text-medium)]">
                    <li>No prompts are stored beyond processing.</li>
                    <li>Keep sensitive data minimal when possible.</li>
                    <li>Review outputs for accuracy before publishing.</li>
                </ul>
            </div>
            <div class="tool-card">
                <h4 class="font-semibold text-[var(--color-text-dark)] mb-2">Tips</h4>
                <ul class="text-sm space-y-1 text-[var(--color-text-medium)]">
                    <li>Add keywords or CTAs you want preserved.</li>
                    <li>Regenerate with a different tone if it feels off.</li>
                    <li>Summaries work best on clear, well-structured text.</li>
                </ul>
            </div>
        </div>

        @await Html.PartialAsync("_AdInContent")
        <partial name="_SocialShare" />
    </div>
</section>

<div id="ai-toast" class="fixed bottom-6 right-6 z-50 hidden transition-all duration-300 transform translate-y-4 opacity-0">
    <div class="rounded-lg shadow-lg px-4 py-3 text-sm font-medium bg-emerald-600 text-white flex items-center gap-2">
        <span class="inline-block w-2 h-2 rounded-full bg-white/90"></span>
        <span id="ai-toast-text">Success</span>
    </div>
</div>

@section Scripts {
    <script>
        const token = document.querySelector('#aiForm input[name="__RequestVerificationToken"]')?.value;
        const modes = ['draft', 'summarize', 'improve'];
        const modeButtons = document.querySelectorAll('[data-mode-btn]');
        const alertBox = document.getElementById('ai-alert');

        const counters = {
            draft: document.getElementById('draft-count'),
            summarizeWord: document.getElementById('summarize-word-count'),
            summarizeChar: document.getElementById('summarize-char-count'),
            improveWord: document.getElementById('improve-word-count'),
            improveChar: document.getElementById('improve-char-count')
        };
        const statusStrip = {
            text: document.getElementById('ai-status-text'),
            dot: document.getElementById('ai-status-dot'),
            last: document.getElementById('ai-last-action')
        };

        function switchMode(mode) {
            modes.forEach(m => {
                const container = document.getElementById(`${m}-mode`);
                const btn = document.querySelector(`[data-mode-btn="${m}"]`);
                if (m === mode) {
                    btn.classList.remove('bg-gray-100', 'bg-gray-200', 'text-gray-800', 'hover:bg-gray-200', 'hover:bg-gray-300', 'border', 'border-[var(--color-border)]');
                    btn.classList.add('btn-primary', 'text-white', 'shadow-lg', 'shadow-[var(--color-primary)]/25');
                    container.classList.remove('hidden');
                } else {
                    btn.classList.remove('btn-primary', 'btn-secondary', 'btn-accent', 'text-white', 'shadow-lg', 'shadow-[var(--color-primary)]/25');
                    btn.classList.add('bg-gray-100', 'text-gray-800', 'hover:bg-gray-200', 'border', 'border-[var(--color-border)]');
                    container.classList.add('hidden');
                }
            });
            hideAlert();
        }

        modeButtons.forEach(btn => btn.addEventListener('click', () => {
            const mode = btn.getAttribute('data-mode-btn');
            switchMode(mode);
        }));

        function showAlert(message, type = 'error') {
            alertBox.textContent = message;
            alertBox.classList.remove('hidden');
            alertBox.classList.toggle('border-red-300', type === 'error');
            alertBox.classList.toggle('text-red-800', type === 'error');
            alertBox.classList.toggle('bg-red-50', type === 'error');
            alertBox.classList.toggle('border-green-300', type === 'success');
            alertBox.classList.toggle('text-green-800', type === 'success');
            alertBox.classList.toggle('bg-green-50', type === 'success');

            updateStatus(type === 'success' ? 'Ready' : 'Check input', type, statusStrip.last.textContent || 'None');
        }

        function hideAlert() {
            alertBox.classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('ai-toast');
            const text = document.getElementById('ai-toast-text');
            text.textContent = message;
            toast.classList.remove('hidden');
            toast.querySelector('div')?.classList.toggle('bg-emerald-600', type === 'success');
            toast.querySelector('div')?.classList.toggle('bg-rose-600', type === 'error');
            setTimeout(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
            }, 10);
            setTimeout(() => {
                toast.classList.add('translate-y-4', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 250);
            }, 2500);
        }

        function updateStatus(text, state = 'success', action = '') {
            if (!statusStrip.text || !statusStrip.dot) return;
            statusStrip.text.textContent = text;
            statusStrip.last.textContent = action || 'None';
            statusStrip.dot.classList.toggle('bg-emerald-500', state === 'success');
            statusStrip.dot.classList.toggle('bg-amber-500', state === 'warning');
            statusStrip.dot.classList.toggle('bg-rose-500', state === 'error');
        }

        function toggleLoading(buttonId, isLoading) {
            const btn = document.getElementById(buttonId);
            if (!btn) return;
            btn.disabled = isLoading;
            btn.querySelector('.btn-label')?.classList.toggle('hidden', isLoading);
            btn.querySelector('.btn-loading')?.classList.toggle('hidden', !isLoading);
        }

        function updateCounters() {
            const draftPrompt = document.getElementById('draft-prompt');
            counters.draft.textContent = `${draftPrompt.value.length} / 4000 characters`;

            const summarizeText = document.getElementById('summarize-text').value;
            counters.summarizeWord.textContent = `Words: ${countWords(summarizeText)}`;
            counters.summarizeChar.textContent = `Characters: ${summarizeText.length} / 6000`;

            const improveText = document.getElementById('improve-text').value;
            counters.improveWord.textContent = `Words: ${countWords(improveText)}`;
            counters.improveChar.textContent = `Characters: ${improveText.length} / 6000`;
        }

        function countWords(text) {
            return text.trim().split(/\\s+/).filter(Boolean).length;
        }

        document.getElementById('draft-prompt').addEventListener('input', updateCounters);
        document.getElementById('summarize-text').addEventListener('input', updateCounters);
        document.getElementById('improve-text').addEventListener('input', updateCounters);
        updateCounters();

        // Sample prompt buttons
        document.querySelectorAll('.sample-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const text = btn.getAttribute('data-sample') || '';
                const target = document.activeElement?.id === 'improve-goal' ? 'improve-goal' : null;
                if (btn.closest('#draft-mode')) {
                    document.getElementById('draft-prompt').value = text;
                    document.getElementById('draft-prompt').focus();
                } else if (btn.closest('#summarize-mode')) {
                    document.getElementById('summarize-text').value = text;
                    document.getElementById('summarize-text').focus();
                } else if (btn.closest('#improve-mode')) {
                    document.getElementById('improve-text').value = text;
                    document.getElementById('improve-text').focus();
                }
                updateCounters();
            });
        });

        // Tone chips quick select
        document.querySelectorAll('.tone-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const tone = chip.getAttribute('data-tone');
                const select = document.getElementById('draft-tone');
                if (tone && select) {
                    select.value = tone;
                }
            });
        });

        async function postAi(url, formData) {
            if (token) {
                formData.append('__RequestVerificationToken', token);
            }
            const res = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: token ? { 'RequestVerificationToken': token } : {}
            });
            return await res.json();
        }

        function renderResult(containerId, outputId, metaId, data) {
            document.getElementById(outputId).textContent = data.text ?? '';
            document.getElementById(containerId).classList.remove('hidden');
            renderMeta(metaId, data.meta);
        }

        function renderMeta(metaId, meta) {
            const el = document.getElementById(metaId);
            if (!meta) {
                el.classList.add('hidden');
                return;
            }

            const parts = [
                `Mode: ${meta.mode}`,
                `Tone: ${meta.tone}`,
                `Length: ${meta.length}`,
                `Estimated tokens: ${meta.estimatedTokens}`
            ];

            const tips = Array.isArray(meta.tips) && meta.tips.length
                ? `<div class="mt-1">Tips:<ul class="list-disc list-inside space-y-1">${meta.tips.map(t => `<li>${t}</li>`).join('')}</ul></div>`
                : '';

            el.innerHTML = `<div>${parts.join(' | ')}</div>${tips}`;
            el.classList.remove('hidden');
        }

        // Draft handler
        document.getElementById('draft-generate').addEventListener('click', async () => {
            hideAlert();
            const prompt = document.getElementById('draft-prompt').value.trim();
            if (!prompt) {
                showAlert('Please enter a topic or prompt.');
                return;
            }
            const tone = document.getElementById('draft-tone').value;
            const length = document.getElementById('draft-length').value;

            toggleLoading('draft-generate', true);
            const formData = new FormData();
            formData.append('Prompt', prompt);
            formData.append('Tone', tone);
            formData.append('Length', length);

            try {
                const result = await postAi('/Trending/Draft', formData);
                if (result.success) {
                    renderResult('draft-result', 'draft-output', 'draft-meta', result);
                    showAlert('Draft created successfully.', 'success');
                    showToast('Draft ready');
                    updateStatus('Draft ready', 'success', 'Draft');
                } else {
                    showAlert(result.error || 'Unable to generate draft.');
                    showToast('Draft failed', 'error');
                    updateStatus('Draft failed', 'error', 'Draft');
                }
            } catch {
                showAlert('Unable to reach the server. Try again.');
                showToast('Network error', 'error');
                updateStatus('Network error', 'error', 'Draft');
            } finally {
                toggleLoading('draft-generate', false);
            }
        });

        // Summary handler
        document.getElementById('summarize-generate').addEventListener('click', async () => {
            hideAlert();
            const text = document.getElementById('summarize-text').value.trim();
            if (!text) {
                showAlert('Please paste text to summarize.');
                return;
            }
            const length = document.getElementById('summarize-length').value;

            toggleLoading('summarize-generate', true);
            const formData = new FormData();
            formData.append('Text', text);
            formData.append('Length', length);

            try {
                const result = await postAi('/Trending/Summarize', formData);
                if (result.success) {
                    renderResult('summarize-result', 'summarize-output', 'summarize-meta', result);
                    showAlert('Summary generated.', 'success');
                    showToast('Summary ready');
                    updateStatus('Summary ready', 'success', 'Summarize');
                } else {
                    showAlert(result.error || 'Unable to summarize text.');
                    showToast('Summary failed', 'error');
                    updateStatus('Summary failed', 'error', 'Summarize');
                }
            } catch {
                showAlert('Unable to reach the server. Try again.');
                showToast('Network error', 'error');
                updateStatus('Network error', 'error', 'Summarize');
            } finally {
                toggleLoading('summarize-generate', false);
            }
        });

        // Improve handler
        document.getElementById('improve-generate').addEventListener('click', async () => {
            hideAlert();
            const text = document.getElementById('improve-text').value.trim();
            if (!text) {
                showAlert('Please add text to improve.');
                return;
            }
            const goal = document.getElementById('improve-goal').value.trim();

            toggleLoading('improve-generate', true);
            const formData = new FormData();
            formData.append('Text', text);
            if (goal) formData.append('Goal', goal);

            try {
                const result = await postAi('/Trending/Improve', formData);
                if (result.success) {
                    renderResult('improve-result', 'improve-output', 'improve-meta', result);
                    showAlert('Improved draft ready.', 'success');
                    showToast('Improvement ready');
                    updateStatus('Improvement ready', 'success', 'Improve');
                } else {
                    showAlert(result.error || 'Unable to improve text.');
                    showToast('Improve failed', 'error');
                    updateStatus('Improve failed', 'error', 'Improve');
                }
            } catch {
                showAlert('Unable to reach the server. Try again.');
                showToast('Network error', 'error');
                updateStatus('Network error', 'error', 'Improve');
            } finally {
                toggleLoading('improve-generate', false);
            }
        });

        // Copy buttons
        document.getElementById('draft-copy').addEventListener('click', () => copyText('draft-output', 'draft-copy'));
        document.getElementById('summarize-copy').addEventListener('click', () => copyText('summarize-output', 'summarize-copy'));
        document.getElementById('improve-copy').addEventListener('click', () => copyText('improve-output', 'improve-copy'));

        function copyText(sourceId, buttonId) {
            const text = document.getElementById(sourceId).textContent;
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById(buttonId);
                const label = btn.querySelector('span');
                const copyIcon = btn.querySelector('.copy-icon');
                const checkIcon = btn.querySelector('.check-icon');
                const original = label ? label.textContent : '';
                if (label) label.textContent = 'Copied';
                if (copyIcon) copyIcon.classList.add('hidden');
                if (checkIcon) checkIcon.classList.remove('hidden');
                btn.classList.add('scale-[0.97]', 'shadow-lg', 'ring-2', 'ring-emerald-300', 'ring-offset-2');
                setTimeout(() => {
                    if (label) label.textContent = original || 'Copy';
                    if (copyIcon) copyIcon.classList.remove('hidden');
                    if (checkIcon) checkIcon.classList.add('hidden');
                    btn.classList.remove('scale-[0.97]', 'shadow-lg', 'ring-2', 'ring-emerald-300', 'ring-offset-2');
                }, 1200);
            });
        }

        switchMode('draft');
    </script>
}
