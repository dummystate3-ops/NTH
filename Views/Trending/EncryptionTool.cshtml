@using System.Linq
@model BasePageViewModel

@{
    ViewBag.PageTitle = Model.PageTitle;
    ViewBag.MetaDescription = Model.MetaDescription;
    ViewBag.CanonicalUrl = Model.CanonicalUrl;
}

<!-- Page Header -->
<section class="section-padding bg-gradient-to-br from-[var(--color-primary)] via-[var(--color-secondary)] to-[var(--color-accent)] text-white">
    <div class="container-custom">
        <div class="max-w-4xl mx-auto text-center">
            <div class="text-6xl mb-4">üîê</div>
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Encryption Tool</h1>
            <p class="text-xl opacity-90">Encrypt and decrypt text securely in your browser</p>
        </div>
    </div>
</section>

<!-- Tool Section -->
<section class="section-padding">
    <div class="container-custom max-w-4xl">
        @{
            var breadcrumbs = new System.Collections.Generic.List<(string Name, string Url)>
            {
                ("Home", Url.Action("Index", "Home") ?? "/"),
                ("All Tools", Url.Action("Index", "Tools") ?? "/Tools"),
                ("Trending & AI Tools", (Url.Action("Index", "Tools") ?? "/Tools") + "#trending"),
                ("Encryption Tool", Url.Action("EncryptionTool", "Trending") ?? "#")
            };
        }
        <partial name="_Breadcrumb" model="breadcrumbs" />
        <form id="encryptionForm">
            @Html.AntiForgeryToken()
        </form>

        @await Html.PartialAsync("_ValidationSummary", Enumerable.Empty<string>())
        
        
        <!-- Mode Selection -->
        <div class="tool-card mb-8">
            <div class="flex flex-wrap gap-4">
                <button id="mode-encrypt" type="button" class="btn-primary flex-1 min-w-[200px]">üîí Encrypt</button>
                <button id="mode-decrypt" type="button" class="btn-secondary flex-1 min-w-[200px]">üîì Decrypt</button>
            </div>
        </div>

        <!-- Encrypt Mode -->
        <div id="encrypt-mode" class="tool-card">
            <h2 class="text-2xl font-bold mb-4 text-[var(--color-text-dark)]">Encrypt Text</h2>
            <p class="text-[var(--color-text-medium)] mb-6">Enter your text and a password to encrypt it securely.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]">Text to Encrypt</label>
                    <textarea id="encrypt-text" rows="6" class="w-full p-4 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent resize-none font-mono" placeholder="Enter your sensitive text here..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]">Encryption Password</label>
                    <input type="password" id="encrypt-password" class="w-full p-3 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)]" placeholder="Enter a strong password">
                    <p class="text-sm text-[var(--color-text-medium)] mt-1">‚ö†Ô∏è Remember this password - you'll need it to decrypt!</p>
                    <div class="mt-2">
                        <div class="h-2 bg-[var(--color-border)] rounded-full overflow-hidden">
                            <div id="password-strength-bar" class="h-2 w-0 bg-[var(--color-primary)] transition-all duration-200"></div>
                        </div>
                        <p id="password-strength-text" class="text-sm text-[var(--color-text-medium)] mt-1"></p>
                    </div>
                </div>

                <button id="encrypt-btn" class="btn-primary w-full">
                    <span id="encrypt-btn-text">üîí Encrypt</span>
                    <span id="encrypt-loading" class="hidden">‚è≥ Encrypting...</span>
                </button>
            </div>

                        <div id="encrypt-result" class="mt-6 hidden">
                <div class="flex items-center justify-between mb-4 gap-2 flex-wrap">
                    <h3 class="text-xl font-bold text-[var(--color-text-dark)]">Encrypted Text</h3>
                    <div class="flex items-center gap-2">
                        <button id="encrypt-copy" class="btn-secondary">Copy</button>
                        <button id="encrypt-download" class="btn-outline">Download</button>
                    </div>
                </div>
                <textarea id="encrypt-output" rows="6" readonly class="w-full p-4 bg-[var(--color-neutral-100)] border border-[var(--color-neutral-300)] rounded-lg font-mono text-sm resize-none"></textarea>
            </div>
        </div>

        <!-- Decrypt Mode -->
        <div id="decrypt-mode" class="tool-card hidden">
            <h2 class="text-2xl font-bold mb-4 text-[var(--color-text-dark)]">Decrypt Text</h2>
            <p class="text-[var(--color-text-medium)] mb-6">Paste your encrypted text and enter the password to decrypt it.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]">Encrypted Text</label>
                    <textarea id="decrypt-text" rows="6" class="w-full p-4 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent resize-none font-mono text-sm" placeholder="Paste encrypted text here..."></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-[var(--color-text-dark)]">Decryption Password</label>
                    <input type="password" id="decrypt-password" class="w-full p-3 border border-[var(--color-neutral-300)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)]" placeholder="Enter the password">
                </div>

                <button id="decrypt-btn" class="btn-primary w-full">
                    <span id="decrypt-btn-text">üîì Decrypt</span>
                    <span id="decrypt-loading" class="hidden">‚è≥ Decrypting...</span>
                </button>
            </div>

            <div id="decrypt-result" class="mt-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-[var(--color-text-dark)]">Decrypted Text</h3>
                    <button id="decrypt-copy" class="btn-secondary">Copy</button>
                </div>
                <textarea id="decrypt-output" rows="6" readonly class="w-full p-4 bg-[var(--color-neutral-100)] border border-[var(--color-neutral-300)] rounded-lg resize-none"></textarea>
            </div>

            <div id="decrypt-error" class="mt-6 hidden">
                <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded-lg">
                    <p id="decrypt-error-message" class="text-red-700">‚ùå Decryption failed. Please check your password and encrypted text.</p>
                </div>
            </div>
        </div>

        <!-- Security Warning -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg mt-8">
            <div class="flex items-start">
                <span class="text-3xl mr-4">‚ö†Ô∏è</span>
                <div>
                    <h3 class="font-bold text-lg mb-2 text-yellow-800">Security Notice</h3>
                    <ul class="list-disc list-inside space-y-2 text-yellow-700">
                        <li><strong>Educational Purpose:</strong> This tool is for learning and basic protection only.</li>
                        <li><strong>Client-Side Only:</strong> All encryption happens in your browser. No data is sent to servers.</li>
                        <li><strong>Not Military-Grade:</strong> For sensitive data, use dedicated security software.</li>
                        <li><strong>Password Recovery:</strong> If you forget your password, the data cannot be recovered.</li>
                        <li><strong>Algorithm:</strong> Uses AES-256-GCM encryption via Web Crypto API.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Privacy Notice -->
        <div class="bg-blue-50 border-l-4 border-blue-400 p-6 rounded-lg mt-8">
            <p class="text-blue-800">
                <strong>üîí Privacy:</strong> All encryption and decryption is performed locally in your browser using the Web Crypto API. Your data never leaves your device.
            </p>
        </div>

        <!-- FAQs -->
        <div class="mt-8 card">
            <h3 class="text-xl font-semibold mb-4">Encryption tool FAQs</h3>
            <div class="space-y-4 text-sm text-[var(--color-text-medium)]">
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">Is my plaintext ever uploaded to the server?</p>
                    <p>
                        The design of this tool is to perform the cryptographic operations in your browser using the Web Crypto API.
                        Your plaintext and password are not intended to be sent to NovaTools Hub servers; only the ciphertext you copy
                        or download leaves your device.
                    </p>
                </div>
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">What happens if I lose or forget my password?</p>
                    <p>
                        There is no backdoor or recovery mechanism. Without the exact password used to encrypt, the ciphertext
                        cannot be decrypted. Always keep important passwords stored safely in a trusted password manager.
                    </p>
                </div>
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">Should I rely on this tool for highly sensitive data?</p>
                    <p>
                        While the tool uses strong AES-256-GCM encryption, it is still a browser-based utility and is best suited
                        for educational use and light protection. Production systems handling highly sensitive data should rely on
                        dedicated, audited security infrastructure and key management solutions.
                    </p>
                </div>
            </div>
        </div>

        <!-- In-Content Ad -->
        @await Html.PartialAsync("_AdInContent")

        <!-- Social Sharing -->
        <div class="mt-8">
            <partial name="_SocialSharing" />
        </div>
    </div>
</section>

@section Scripts {
    <script>
        var modeButtons = {
            encrypt: document.getElementById('mode-encrypt'),
            decrypt: document.getElementById('mode-decrypt')
        };
        var modeContainers = {
            encrypt: document.getElementById('encrypt-mode'),
            decrypt: document.getElementById('decrypt-mode')
        };

        function switchMode(mode) {
            ['encrypt', 'decrypt'].forEach(function (key) {
                var btn = modeButtons[key];
                var container = modeContainers[key];

                if (key === mode) {
                    if (btn) {
                        btn.classList.remove('bg-gray-200', 'text-gray-700');
                        btn.classList.add(key === 'encrypt' ? 'btn-primary' : 'btn-secondary');
                    }
                    if (container) container.classList.remove('hidden');
                } else {
                    if (btn) {
                        btn.classList.remove('btn-primary', 'btn-secondary');
                        btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    }
                    if (container) container.classList.add('hidden');
                }
            });

            clearErrors();
            var de = document.getElementById('decrypt-error');
            if (de) de.classList.add('hidden');
        }

        if (modeButtons.encrypt) modeButtons.encrypt.addEventListener('click', function () { switchMode('encrypt'); });
        if (modeButtons.decrypt) modeButtons.decrypt.addEventListener('click', function () { switchMode('decrypt'); });

        var antiforgeryField = document.querySelector('#encryptionForm input[name="__RequestVerificationToken"]');
        var antiforgeryToken = antiforgeryField ? antiforgeryField.value : null;
        var validationSummary = document.querySelector('[data-validation-summary]');
        var validationList = validationSummary ? validationSummary.querySelector('[data-validation-summary-list]') : null;
        var decryptError = document.getElementById('decrypt-error');
        var decryptErrorMessage = document.getElementById('decrypt-error-message');
        var encryptOutput = document.getElementById('encrypt-output');
        var decryptOutput = document.getElementById('decrypt-output');
        var encryptTextField = document.getElementById('encrypt-text');
        var decryptTextField = document.getElementById('decrypt-text');
        var decryptPasswordField = document.getElementById('decrypt-password');

        function showErrors(errors) {
            if (!validationSummary || !validationList) return;
            validationList.innerHTML = '';
            (errors || []).filter(Boolean).forEach(message => {
                const li = document.createElement('li');
                li.textContent = message;
                validationList.appendChild(li);
            });
            validationSummary.classList.remove('hidden');
        }

        function clearErrors() {
            if (validationList) {
                validationList.innerHTML = '';
            }
            if (validationSummary) {
                validationSummary.classList.add('hidden');
            }
        }

        async function postEncryption(url, text, password) {
            const formData = new FormData();
            formData.append('Text', text);
            formData.append('Password', password);
            if (antiforgeryToken) {
                formData.append('__RequestVerificationToken', antiforgeryToken);
            }

            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: antiforgeryToken ? { 'RequestVerificationToken': antiforgeryToken } : {}
            });

            if (!response.ok) {
                throw new Error('Request failed with status ' + response.status);
            }

            return response.json();
        }

        function setLoading(buttonId, loadingId, isLoading) {
            const btnText = document.getElementById(buttonId);
            const loading = document.getElementById(loadingId);
            if (isLoading) {
                if (btnText) btnText.classList.add('hidden');
                if (loading) loading.classList.remove('hidden');
            } else {
                if (btnText) btnText.classList.remove('hidden');
                if (loading) loading.classList.add('hidden');
            }
        }

        function scorePassword(password) {
            let score = 0;
            if (password.length >= 12) score += 2;
            else if (password.length >= 8) score += 1;
            if (/[A-Z]/.test(password)) score += 1;
            if (/[a-z]/.test(password)) score += 1;
            if (/[0-9]/.test(password)) score += 1;
            if (/[^A-Za-z0-9]/.test(password)) score += 1;
            return Math.min(score, 5);
        }

        function renderPasswordStrength(password) {
            const bar = document.getElementById('password-strength-bar');
            const text = document.getElementById('password-strength-text');
            if (!bar || !text) return;

            const score = scorePassword(password);
            const percent = (score / 5) * 100;
            let label = '';
            let color = 'var(--color-border)';

            if (!password) {
                bar.style.width = '0%';
                text.textContent = '';
                return;
            }

            if (score >= 4) {
                label = 'Strong';
                color = 'var(--color-primary)';
            } else if (score >= 3) {
                label = 'Medium';
                color = 'var(--color-secondary)';
            } else {
                label = 'Weak';
                color = 'var(--color-warning)';
            }

            bar.style.width = `${percent}%`;
            bar.style.backgroundColor = color;
            text.textContent = `Password strength: ${label}`;
        }

        var encryptPassword = document.getElementById('encrypt-password');
        if (encryptPassword) {
            encryptPassword.addEventListener('input', function (event) {
                renderPasswordStrength(event.target.value);
            });
        }

        var encryptBtn = document.getElementById('encrypt-btn');
        if (encryptBtn) encryptBtn.addEventListener('click', async function () {
            clearErrors();

            const text = (encryptTextField ? encryptTextField.value : '').trim();
            const password = encryptPassword ? encryptPassword.value : '';
            const errors = [];
            if (!text) errors.push('Please enter text to encrypt.');
            if (!password || password.length < 6) errors.push('Password must be at least 6 characters.');

            if (errors.length) {
                showErrors(errors);
                return;
            }

            setLoading('encrypt-btn-text', 'encrypt-loading', true);
            this.disabled = true;

            try {
                const result = await postEncryption('/Trending/Encrypt', text, password);
                if (result.success) {
                    encryptOutput.value = result.cipher || '';
                    document.getElementById('encrypt-result').classList.remove('hidden');
                } else {
                    showErrors([result.error || 'Encryption failed.']);
                }
            } catch (error) {
                console.error(error);
                showErrors(['Encryption failed. Please try again.']);
            }

            setLoading('encrypt-btn-text', 'encrypt-loading', false);
            this.disabled = false;
        });

        var decryptBtn = document.getElementById('decrypt-btn');
        if (decryptBtn) decryptBtn.addEventListener('click', async function () {
            clearErrors();
            if (decryptError) decryptError.classList.add('hidden');

            const encryptedText = (decryptTextField ? decryptTextField.value : '').trim();
            const password = decryptPasswordField ? decryptPasswordField.value : '';
            const errors = [];
            if (!encryptedText) errors.push('Please enter encrypted text.');
            if (!password || password.length < 6) errors.push('Please enter the password used to encrypt (min 6 characters).');

            if (errors.length) {
                showErrors(errors);
                return;
            }

            setLoading('decrypt-btn-text', 'decrypt-loading', true);
            this.disabled = true;

            var dr = document.getElementById('decrypt-result');
            if (dr) dr.classList.add('hidden');

            try {
                const result = await postEncryption('/Trending/Decrypt', encryptedText, password);
                if (result.success) {
                    decryptOutput.value = result.plain || '';
                    document.getElementById('decrypt-result').classList.remove('hidden');
                } else {
                    const message = result.error || 'Unable to decrypt with that password.';
                if (decryptErrorMessage) decryptErrorMessage.textContent = message;
                if (decryptError) decryptError.classList.remove('hidden');
                showErrors([message]);
            }
        } catch (error) {
            console.error(error);
            const fallback = 'Decryption failed. Please double-check the password and ciphertext.';
            if (decryptErrorMessage) decryptErrorMessage.textContent = fallback;
            if (decryptError) decryptError.classList.remove('hidden');
            showErrors([fallback]);
        }

            setLoading('decrypt-btn-text', 'decrypt-loading', false);
            this.disabled = false;
        });

        var encryptCopy = document.getElementById('encrypt-copy');
        if (encryptCopy) {
            encryptCopy.addEventListener('click', function () {
                const text = encryptOutput.value;
                navigator.clipboard.writeText(text).then(() => {
                    this.textContent = 'Copied!';
                    setTimeout(() => this.textContent = 'Copy', 1500);
                });
            });
        }

        var encryptDownload = document.getElementById('encrypt-download');
        if (encryptDownload) {
            encryptDownload.addEventListener('click', function () {
                const cipher = encryptOutput.value.trim();
                if (!cipher) {
                    showErrors(['Nothing to download yet. Encrypt some text first.']);
                    return;
                }

                const blob = new Blob([cipher], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'encrypted.txt';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });
        }

        var decryptCopy = document.getElementById('decrypt-copy');
        if (decryptCopy) {
            decryptCopy.addEventListener('click', function () {
                const text = decryptOutput.value;
                navigator.clipboard.writeText(text).then(() => {
                    this.textContent = 'Copied!';
                    setTimeout(() => this.textContent = 'Copy', 1500);
                });
            });
        }

        renderPasswordStrength(document.getElementById('encrypt-password') ? document.getElementById('encrypt-password').value : '');
    </script>
}

