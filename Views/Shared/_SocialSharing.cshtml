@using System

@{
    var canonical = ViewBag.CanonicalUrl as string;
    var pageUrl = !string.IsNullOrEmpty(canonical)
        ? canonical
        : Context.Request.Scheme + "://" + Context.Request.Host + Context.Request.Path + Context.Request.QueryString;
    var pageTitle = ViewBag.PageTitle ?? "NovaTools Hub";
    var encodedUrl = Uri.EscapeDataString(pageUrl);
    var encodedTitle = Uri.EscapeDataString(pageTitle);
}

<div id="social-sharing-panel"
     class="card relative overflow-hidden border border-[var(--color-border)] bg-[var(--color-surface)]"
     data-share-url="@encodedUrl"
     data-share-title="@encodedTitle">
    <div class="absolute inset-y-0 left-0 w-1 bg-gradient-to-b from-[var(--color-primary)] to-[var(--color-secondary)] opacity-80"></div>

    <div class="pl-5 sm:pl-6 pr-4 sm:pr-6 py-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <!-- Text -->
            <div class="flex-1 space-y-1">
                <p class="text-[0.7rem] font-semibold tracking-[0.15em] uppercase text-[var(--color-text-subtle)]">
                    Share this tool
                </p>
                <h3 class="text-lg font-bold text-[var(--color-text-dark)]">
                    Help someone else shortcut their work
                </h3>
                <p class="text-sm text-[var(--color-text-medium)]">
                    Send this page to a friend, student, or teammate who could benefit from it.
                </p>
            </div>

            <!-- Buttons -->
            <div class="flex flex-wrap gap-2 md:justify-end">
                <button type="button"
                        class="pill-button text-xs md:text-sm flex items-center gap-1.5"
                        onclick="window.novaShareTool && window.novaShareTool('twitter')"
                        aria-label="Share on X (Twitter)">
                    <span class="text-base">ùïè</span>
                    <span class="hidden sm:inline">Post</span>
                </button>

                <button type="button"
                        class="pill-button text-xs md:text-sm flex items-center gap-1.5"
                        onclick="window.novaShareTool && window.novaShareTool('whatsapp')"
                        aria-label="Share on WhatsApp">
                    <span class="text-base">üü¢</span>
                    <span class="hidden sm:inline">WhatsApp</span>
                </button>

                <button type="button"
                        class="pill-button text-xs md:text-sm flex items-center gap-1.5"
                        onclick="window.novaShareTool && window.novaShareTool('linkedin')"
                        aria-label="Share on LinkedIn">
                    <span class="text-base">in</span>
                    <span class="hidden sm:inline">LinkedIn</span>
                </button>

                <button type="button"
                        class="pill-button text-xs md:text-sm flex items-center gap-1.5"
                        onclick="window.novaShareTool && window.novaShareTool('facebook')"
                        aria-label="Share on Facebook">
                    <span class="text-base">f</span>
                    <span class="hidden sm:inline">Facebook</span>
                </button>

                <button type="button"
                        id="social-copy-button"
                        class="pill-button is-active text-xs md:text-sm flex items-center gap-1.5"
                        onclick="window.novaCopyShareLink && window.novaCopyShareLink()"
                        aria-label="Copy link to this tool">
                    <span id="social-copy-icon" class="text-base">üîó</span>
                    <span id="social-copy-label">Copy link</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        let copyTimeoutId;

        function getMeta() {
            const panel = document.getElementById('social-sharing-panel');
            if (!panel) {
                return {
                    url: encodeURIComponent(window.location.href),
                    title: encodeURIComponent(document.title || 'NovaTools Hub')
                };
            }
            return {
                url: panel.getAttribute('data-share-url') || encodeURIComponent(window.location.href),
                title: panel.getAttribute('data-share-title') || encodeURIComponent(document.title || 'NovaTools Hub')
            };
        }

        function openPopup(url) {
            const width = 560;
            const height = 520;
            const left = (window.screen.width / 2) - (width / 2);
            const top = (window.screen.height / 2) - (height / 2);
            window.open(
                url,
                '_blank',
                `width=${width},height=${height},left=${left},top=${top},noopener`
            );
        }

        function setCopiedVisualState() {
            const btn = document.getElementById('social-copy-button');
            const icon = document.getElementById('social-copy-icon');
            const label = document.getElementById('social-copy-label');
            if (!btn || !icon || !label) return;

            if (copyTimeoutId) {
                clearTimeout(copyTimeoutId);
            }

            btn.classList.add('bg-emerald-500', 'border-emerald-500', 'text-white', 'shadow-md');
            icon.textContent = '‚úì';
            label.textContent = 'Copied';

            copyTimeoutId = window.setTimeout(function () {
                btn.classList.remove('bg-emerald-500', 'border-emerald-500', 'text-white', 'shadow-md');
                icon.textContent = 'üîó';
                label.textContent = 'Copy link';
            }, 2000);
        }

        window.novaShareTool = function (platform) {
            const meta = getMeta();
            const url = meta.url;
            const title = meta.title;

            if (!platform) return;

            let shareUrl = null;
            switch (platform) {
                case 'twitter':
                    shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
                    break;
                case 'facebook':
                    shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                    break;
                case 'linkedin':
                    shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
                    break;
                case 'whatsapp':
                    shareUrl = `https://wa.me/?text=${title}%20${url}`;
                    window.open(shareUrl, '_blank');
                    return;
                default:
                    return;
            }

            openPopup(shareUrl);
        };

        window.novaCopyShareLink = function () {
            const panel = document.getElementById('social-sharing-panel');
            const rawUrl = panel
                ? (panel.getAttribute('data-share-url') ? decodeURIComponent(panel.getAttribute('data-share-url')) : window.location.href)
                : window.location.href;

            if (!navigator.clipboard || !navigator.clipboard.writeText) {
                try {
                    const temp = document.createElement('textarea');
                    temp.value = rawUrl;
                    temp.style.position = 'fixed';
                    temp.style.opacity = '0';
                    document.body.appendChild(temp);
                    temp.select();
                    document.execCommand('copy');
                    document.body.removeChild(temp);

                    setCopiedVisualState();

                    if (window.toast && window.toast.success) {
                        window.toast.success('Link copied to clipboard.');
                    }
                } catch (err) {
                    console.error('Copy failed:', err);
                    if (window.toast && window.toast.error) {
                        window.toast.error('Failed to copy link');
                    }
                }
                return;
            }

            navigator.clipboard.writeText(rawUrl)
                .then(function () {
                    setCopiedVisualState();

                    if (window.toast && window.toast.success) {
                        window.toast.success('Link copied to clipboard.');
                    }
                })
                .catch(function (err) {
                    console.error('Copy failed:', err);
                    if (window.toast && window.toast.error) {
                        window.toast.error('Failed to copy link');
                    }
                });
        };
    })();
</script>