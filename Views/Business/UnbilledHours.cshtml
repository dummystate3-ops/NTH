@model BasePageViewModel

@{
    ViewBag.PageTitle = Model.PageTitle;
    ViewBag.MetaDescription = Model.MetaDescription;
    ViewBag.CanonicalUrl = Model.CanonicalUrl;
}



<!-- Page Header -->
<section class="section-padding bg-gradient-to-br from-[var(--color-primary)] via-[var(--color-secondary)] to-[var(--color-accent)] text-white">
    <div class="container-custom">
        <div class="max-w-4xl mx-auto text-center">
            <div class="text-5xl mb-4">‚è∞</div>
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Unbilled Hours Estimator</h1>
            <p class="text-xl opacity-90">Track and value your unbilled work hours for better revenue management</p>
        </div>
    </div>
</section>

<!-- Calculator Section -->
<section class="section-padding">
    <div class="container-custom max-w-6xl">
        
        @{
            var breadcrumbs = new System.Collections.Generic.List<(string Name, string Url)>
            {
                ("Home", Url.Action("Index", "Home") ?? "/"),
                ("All Tools", Url.Action("Index", "Tools") ?? "/Tools"),
                ("Business & Finance Tools", (Url.Action("Index", "Tools") ?? "/Tools") + "#business"),
                ("Unbilled Hours Estimator", Url.Action("UnbilledHours", "Business") ?? "#")
            };
        }
        <partial name="_Breadcrumb" model="breadcrumbs" />
        
        <!-- Privacy Notice -->
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-8">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                </svg>
                <div class="text-sm text-blue-900 dark:text-blue-100">
                    <strong>Your privacy matters:</strong> All data is stored locally in your browser. No information is sent to our servers.
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Input Panel -->
            <div class="lg:col-span-2 card">
                <h2 class="text-2xl font-bold mb-6">Track Unbilled Hours</h2>
                
                <div class="mb-6">
                    <label for="currency" class="block text-sm font-medium mb-2">Currency</label>
                    <select id="currency" class="w-full px-4 py-2 border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] dark:bg-gray-800">
                        <option value="USD" data-symbol="$">USD - US Dollar ($)</option>
                        <option value="PKR" data-symbol="‚Ç®">PKR - Pakistani Rupee (‚Ç®)</option>
                        <option value="INR" data-symbol="‚Çπ">INR - Indian Rupee (‚Çπ)</option>
                        <option value="SAR" data-symbol="Ô∑º">SAR - Saudi Riyal (Ô∑º)</option>
                        <option value="AED" data-symbol="ÿØ.ÿ•">AED - UAE Dirham (ÿØ.ÿ•)</option>
                        <option value="EUR" data-symbol="‚Ç¨">EUR - Euro (‚Ç¨)</option>
                        <option value="GBP" data-symbol="¬£">GBP - British Pound (¬£)</option>
                    </select>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Client/Project -->
                    <div>
                        <label for="projectName" class="block text-sm font-medium mb-2">
                            Client/Project Name
                        </label>
                        <input type="text" id="projectName" 
                               class="w-full px-4 py-2 border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent dark:bg-gray-800"
                               placeholder="e.g., ABC Corp Website">
                    </div>

                    <!-- Hourly Rate -->
                    <div>
                        <label for="hourlyRate" class="block text-sm font-medium mb-2">
                            Hourly Rate
                        </label>
                        <div class="relative">
                            <span id="rateSymbol" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                            <input type="number" id="hourlyRate" step="0.01" min="0" 
                                   class="w-full pl-8 pr-4 py-2 border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent dark:bg-gray-800"
                                   placeholder="100.00">
                        </div>
                    </div>

                    <!-- Hours Worked -->
                    <div>
                        <label for="hoursWorked" class="block text-sm font-medium mb-2">
                            Hours Worked
                        </label>
                        <input type="number" id="hoursWorked" step="0.25" min="0" 
                               class="w-full px-4 py-2 border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent dark:bg-gray-800"
                               placeholder="8.5">
                    </div>

                    <!-- Date -->
                    <div>
                        <label for="workDate" class="block text-sm font-medium mb-2">
                            Date
                        </label>
                        <input type="date" id="workDate" 
                               class="w-full px-4 py-2 border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent dark:bg-gray-800">
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <label for="description" class="block text-sm font-medium mb-2">
                        Work Description (Optional)
                    </label>
                    <textarea id="description" rows="2"
                              class="w-full px-4 py-2 border border-[var(--color-border)] rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] focus:border-transparent dark:bg-gray-800"
                              placeholder="Brief description of work performed"></textarea>
                </div>

                <!-- Add Entry Button -->
                <button onclick="addEntry()" class="btn btn-primary w-full md:w-auto">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Entry
                </button>

                <!-- Entries List -->
                <div class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold">Unbilled Entries</h3>
                        <button onclick="clearAllEntries()" class="text-sm text-red-600 hover:underline">Clear All</button>
                    </div>
                    <div id="entriesList" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Entries will be added here -->
                    </div>
                    <div id="emptyList" class="text-center py-8 text-[var(--color-text-medium)]">
                        No entries yet. Add your first unbilled hour entry above.
                    </div>
                </div>
            </div>

            <!-- Summary Panel -->
            <div class="space-y-6">
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Summary</h2>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800">
                            <div class="text-sm text-blue-600 dark:text-blue-400 mb-1">Total Unbilled Hours</div>
                            <div id="totalHours" class="text-3xl font-bold text-blue-700 dark:text-blue-300">0.0</div>
                        </div>

                        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border border-green-200 dark:border-green-800">
                            <div class="text-sm text-green-600 dark:text-green-400 mb-1">Total Unbilled Value</div>
                            <div id="totalValue" class="text-3xl font-bold text-green-700 dark:text-green-300">$0.00</div>
                        </div>

                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-[var(--color-text-medium)]">Number of Entries</span>
                                <span id="entryCount" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-[var(--color-text-medium)]">Average Hourly Rate</span>
                                <span id="avgRate" class="font-semibold">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <button onclick="exportToCSV()" class="btn btn-outline w-full mt-4">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export to CSV
                    </button>
                </div>

                <!-- Quick Stats by Project -->
                <div class="card">
                    <h3 class="text-lg font-bold mb-3">By Project</h3>
                    <div id="projectStats" class="space-y-2 text-sm">
                        <p class="text-[var(--color-text-medium)]">No projects yet</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tips Section -->
        <div class="card mt-8">
            <h3 class="text-xl font-bold mb-4">Tips for Managing Unbilled Hours</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <h4 class="font-semibold mb-2">‚è±Ô∏è Track Regularly</h4>
                    <p class="text-sm text-[var(--color-text-medium)]">
                        Log hours daily to ensure accurate tracking. Set reminders at the end of each workday.
                    </p>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">üìã Be Detailed</h4>
                    <p class="text-sm text-[var(--color-text-medium)]">
                        Include work descriptions to make invoicing easier and justify your billable hours to clients.
                    </p>
                </div>
                <div>
                    <h4 class="font-semibold mb-2">üí∞ Invoice Promptly</h4>
                    <p class="text-sm text-[var(--color-text-medium)]">
                        Convert unbilled hours to invoices regularly (weekly/bi-weekly) to maintain healthy cash flow.
                    </p>
                </div>
            </div>
        </div>

        <!-- FAQs -->
        <div class="card mt-8">
            <h3 class="text-xl font-bold mb-4">Unbilled hours estimator FAQs</h3>
            <div class="space-y-4 text-sm text-[var(--color-text-medium)]">
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">Can I track different clients or projects separately?</p>
                    <p>
                        Yes. Each entry includes a client or project name, and the summary section automatically groups totals by project so you can see where unbilled time is building up.
                    </p>
                </div>
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">What happens if I clear my browser storage or switch devices?</p>
                    <p>
                        Entries are stored only in the current browser. Clearing site data or switching to another device will remove those records, so export to CSV regularly if you need a longer-term backup.
                    </p>
                </div>
                <div>
                    <p class="font-semibold text-[var(--color-text)] mb-1">How should I use these estimates in my invoicing process?</p>
                    <p>
                        Treat the totals as a checklist of work that still needs to be billed. You can export a CSV, reconcile it with your time-tracking or accounting system, and then mark items as invoiced by removing or archiving them here.
                    </p>
                </div>
            </div>
        </div>

        <!-- In-Content Ad -->
        @await Html.PartialAsync("_AdInContent")

        <!-- Social Sharing -->
        <partial name="_SocialSharing" />
    </div>
</section>

@section Scripts {
    <script>
        let entries = JSON.parse(localStorage.getItem('unbilledHours') || '[]');
        let currencySymbol = '$';

        document.getElementById('currency').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            currencySymbol = selectedOption.getAttribute('data-symbol');
            document.getElementById('rateSymbol').textContent = currencySymbol;
            updateSummary();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('workDate').value = new Date().toISOString().split('T')[0];
            renderEntries();
            updateSummary();
        });

        function addEntry() {
            const projectName = document.getElementById('projectName').value.trim();
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value);
            const hoursWorked = parseFloat(document.getElementById('hoursWorked').value);
            const workDate = document.getElementById('workDate').value;
            const description = document.getElementById('description').value.trim();

            // Validation
            if (!projectName) {
                alert('Please enter a project name');
                return;
            }
            if (!hourlyRate || hourlyRate <= 0) {
                alert('Please enter a valid hourly rate');
                return;
            }
            if (!hoursWorked || hoursWorked <= 0) {
                alert('Please enter valid hours worked');
                return;
            }
            if (!workDate) {
                alert('Please select a date');
                return;
            }

            const entry = {
                id: Date.now(),
                projectName,
                hourlyRate,
                hoursWorked,
                workDate,
                description,
                value: hourlyRate * hoursWorked,
                timestamp: new Date().toISOString()
            };

            entries.unshift(entry);
            saveEntries();
            renderEntries();
            updateSummary();

            // Clear form (except rate and project)
            document.getElementById('hoursWorked').value = '';
            document.getElementById('description').value = '';
            document.getElementById('workDate').value = new Date().toISOString().split('T')[0];
        }

        function deleteEntry(id) {
            if (confirm('Are you sure you want to delete this entry?')) {
                entries = entries.filter(e => e.id !== id);
                saveEntries();
                renderEntries();
                updateSummary();
            }
        }

        function clearAllEntries() {
            if (confirm('Are you sure you want to clear all entries? This cannot be undone.')) {
                entries = [];
                saveEntries();
                renderEntries();
                updateSummary();
            }
        }

        function renderEntries() {
            const container = document.getElementById('entriesList');
            const emptyState = document.getElementById('emptyList');

            if (entries.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            emptyState.classList.add('hidden');

            container.innerHTML = entries.map(entry => `
                <div class="border border-[var(--color-border)] rounded-lg p-4 bg-[var(--color-surface)] hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="font-semibold">${entry.projectName}</div>
                            <div class="text-sm text-[var(--color-text-medium)]">${new Date(entry.workDate).toLocaleDateString()}</div>
                        </div>
                        <button onclick="deleteEntry(${entry.id})" class="text-red-600 hover:text-red-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                    ${entry.description ? `<p class="text-sm text-[var(--color-text-medium)] mb-2">${entry.description}</p>` : ''}
                    <div class="flex justify-between items-center text-sm">
                        <span>${entry.hoursWorked} hrs at ${currencySymbol}${entry.hourlyRate}/hr</span>
                        <span class="font-semibold text-green-600 dark:text-green-400">${currencySymbol}${entry.value.toFixed(2)}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateSummary() {
            const totalHours = entries.reduce((sum, e) => sum + e.hoursWorked, 0);
            const totalValue = entries.reduce((sum, e) => sum + e.value, 0);
            const avgRate = entries.length > 0 ? entries.reduce((sum, e) => sum + e.hourlyRate, 0) / entries.length : 0;

            document.getElementById('totalHours').textContent = totalHours.toFixed(1);
            document.getElementById('totalValue').textContent = `${currencySymbol}${totalValue.toFixed(2)}`;
            document.getElementById('entryCount').textContent = entries.length;
            document.getElementById('avgRate').textContent = `${currencySymbol}${avgRate.toFixed(2)}`;

            // Update project stats
            updateProjectStats();
        }

        function updateProjectStats() {
            const projectTotals = {};
            entries.forEach(entry => {
                if (!projectTotals[entry.projectName]) {
                    projectTotals[entry.projectName] = { hours: 0, value: 0 };
                }
                projectTotals[entry.projectName].hours += entry.hoursWorked;
                projectTotals[entry.projectName].value += entry.value;
            });

            const container = document.getElementById('projectStats');
            const projects = Object.keys(projectTotals);

            if (projects.length === 0) {
                container.innerHTML = '<p class="text-[var(--color-text-medium)]">No projects yet</p>';
                return;
            }

            container.innerHTML = projects.map(project => `
                <div class="flex justify-between items-center pb-2 border-b border-[var(--color-border)]">
                    <div>
                        <div class="font-medium">${project}</div>
                        <div class="text-xs text-[var(--color-text-light)]">${projectTotals[project].hours.toFixed(1)} hrs</div>
                    </div>
                    <div class="font-semibold text-green-600 dark:text-green-400">${currencySymbol}${projectTotals[project].value.toFixed(2)}</div>
                </div>
            `).join('');
        }

        function saveEntries() {
            localStorage.setItem('unbilledHours', JSON.stringify(entries));
        }

        function exportToCSV() {
            if (entries.length === 0) {
                alert('No entries to export');
                return;
            }

            const headers = ['Date', 'Project', 'Hours', 'Rate', 'Value', 'Description'];
            const rows = entries.map(e => [
                new Date(e.workDate).toLocaleDateString(),
                e.projectName,
                e.hoursWorked,
                e.hourlyRate,
                e.value.toFixed(2),
                e.description || ''
            ]);

            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `unbilled-hours-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
}
